<div class="event-context-container">
  <h2>Event Context Analysis</h2>

  <div class="controls" *ngIf="!loading">
    <label for="activitySelect">Activity:</label>
    <select id="activitySelect" [(ngModel)]="selectedActivity" (change)="updateCorrelations()">
      <option *ngFor="let act of activities" [value]="act">{{ act }}</option>
    </select>
  </div>

  <div class="tabs" *ngIf="!loading">
    <button (click)="activeTab='before'" [class.active]="activeTab==='before'">Before Event</button>
    <button (click)="activeTab='after'" [class.active]="activeTab==='after'">After Event</button>
  </div>

  <div *ngIf="loading" class="loading">Computing metrics...</div>

  <table *ngIf="!loading && activeTab==='before'" class="corr-table">
    <thead>
      <tr><th>Metric (Past 2 weeks)</th><th>Correlation</th></tr>
    </thead>
    <tbody>
      <tr>
        <td>Under/Overstock occurred</td>
        <td>
          {{ correlations.before.underOver | number:'1.3-3' }}
          <div class="corr-bar"><div class="marker" [style.left.%]="50 + 50 * scaleCorrelation(correlations.before.underOver)"></div></div>
        </td>
      </tr>
      <tr>
        <td># Goods Issue events</td>
        <td>
          {{ correlations.before.goodsIssue | number:'1.3-3' }}
          <div class="corr-bar"><div class="marker" [style.left.%]="50 + 50 * scaleCorrelation(correlations.before.goodsIssue)"></div></div>
        </td>
      </tr>
      <tr>
        <td># Goods Receipt events</td>
        <td>
          {{ correlations.before.goodsReceipt | number:'1.3-3' }}
          <div class="corr-bar"><div class="marker" [style.left.%]="50 + 50 * scaleCorrelation(correlations.before.goodsReceipt)"></div></div>
        </td>
      </tr>
      <tr>
        <td># ST CHANGE events</td>
        <td>
          {{ correlations.before.stChange | number:'1.3-3' }}
          <div class="corr-bar"><div class="marker" [style.left.%]="50 + 50 * scaleCorrelation(correlations.before.stChange)"></div></div>
        </td>
      </tr>
      <tr>
        <td>Stock difference</td>
        <td>
          {{ correlations.before.stockDiff | number:'1.3-3' }}
          <div class="corr-bar"><div class="marker" [style.left.%]="50 + 50 * scaleCorrelation(correlations.before.stockDiff)"></div></div>
        </td>
      </tr>
    </tbody>
  </table>

  <table *ngIf="!loading && activeTab==='after'" class="corr-table">
    <thead>
      <tr><th>Metric (Next 2 weeks)</th><th>Correlation</th></tr>
    </thead>
    <tbody>
      <tr>
        <td>Under/Overstock occurred</td>
        <td>
          {{ correlations.after.underOver | number:'1.3-3' }}
          <div class="corr-bar"><div class="marker" [style.left.%]="50 + 50 * scaleCorrelation(correlations.after.underOver)"></div></div>
        </td>
      </tr>
      <tr>
        <td># Goods Issue events</td>
        <td>
          {{ correlations.after.goodsIssue | number:'1.3-3' }}
          <div class="corr-bar"><div class="marker" [style.left.%]="50 + 50 * scaleCorrelation(correlations.after.goodsIssue)"></div></div>
        </td>
      </tr>
      <tr>
        <td># Goods Receipt events</td>
        <td>
          {{ correlations.after.goodsReceipt | number:'1.3-3' }}
          <div class="corr-bar"><div class="marker" [style.left.%]="50 + 50 * scaleCorrelation(correlations.after.goodsReceipt)"></div></div>
        </td>
      </tr>
      <tr>
        <td># ST CHANGE events</td>
        <td>
          {{ correlations.after.stChange | number:'1.3-3' }}
          <div class="corr-bar"><div class="marker" [style.left.%]="50 + 50 * scaleCorrelation(correlations.after.stChange)"></div></div>
        </td>
      </tr>
      <tr>
        <td>Stock difference</td>
        <td>
          {{ correlations.after.stockDiff | number:'1.3-3' }}
          <div class="corr-bar"><div class="marker" [style.left.%]="50 + 50 * scaleCorrelation(correlations.after.stockDiff)"></div></div>
        </td>
      </tr>
    </tbody>
  </table>
</div>
